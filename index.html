<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Advency • Calculadora Solar</title>

  <style>
    :root{
      --bg:#ffffff;
      --text:#0b1220;
      --muted:#667085;
      --line:#eaecef;
      --card:#ffffff;
      --soft:#fff6eb;
      --orange:#ff7a00;
      --orange2:#ff9a3d;
      --shadow: 0 18px 55px rgba(2,6,23,.08);
      --r:18px;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--sans);background:var(--bg);color:var(--text);}
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 28px;}

    .topbar{
      display:flex;align-items:center;gap:14px;
      padding:12px 14px;border:1px solid var(--line);
      border-radius:999px;background:#fff;
      box-shadow:0 10px 35px rgba(2,6,23,.06);
    }
    .logo{height:34px;width:auto;display:block}
    .brand{display:flex;flex-direction:column;line-height:1.15;gap:3px;min-width:0}
    .brand h1{margin:0;font-size:16px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .brand p{margin:0;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    .card{
      margin-top:14px;border:1px solid var(--line);
      border-radius:var(--r);background:var(--card);
      box-shadow:var(--shadow);overflow:hidden;
    }
    .cardHead{
      padding:14px 16px;border-bottom:1px solid var(--line);
      background:linear-gradient(180deg,#fff,#fffaf3);
    }
    .cardHead .hint{font-size:12px;color:var(--muted)}

    .grid{
      display:grid;grid-template-columns:1fr 1fr;
      gap:12px;padding:14px 16px 4px;
    }
    @media (max-width:820px){.grid{grid-template-columns:1fr}.topbar{border-radius:var(--r)}}

    .field{display:flex;flex-direction:column;gap:6px}
    label{font-size:12px;color:var(--muted);display:flex;align-items:center;gap:8px}
    input{
      width:100%;height:44px;padding:10px 12px;
      border:1px solid var(--line);border-radius:12px;
      font-size:14px;outline:none;background:#fff;
      transition:box-shadow .15s ease,border-color .15s ease;
    }
    input:focus{border-color:rgba(255,122,0,.45);box-shadow:0 0 0 4px rgba(255,122,0,.12)}
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:520px){.row2{grid-template-columns:1fr}}

    .kpi{
      display:grid;grid-template-columns:1fr 1fr;
      gap:12px;padding:12px 16px 16px;
    }
    @media (max-width:820px){.kpi{grid-template-columns:1fr}}
    .box{
      border:1px solid var(--line);border-radius:16px;
      padding:12px 14px;background:#fff;
    }
    .box.soft{
      background:linear-gradient(180deg,var(--soft),#fff);
      border-color:rgba(255,122,0,.18);
    }
    .box .t{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.08em;margin-bottom:6px}
    .box .v{font-size:28px;font-weight:800}
    .box .s{margin-top:6px;font-size:12px;color:var(--muted)}

    .footer{
      display:flex;align-items:center;justify-content:space-between;
      gap:12px;padding:12px 16px 16px;border-top:1px solid var(--line);background:#fff;
    }
    .formula{
      font-size:12px;color:var(--muted);line-height:1.35;
      overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:62%;
    }
    @media (max-width:820px){
      .formula{max-width:100%;white-space:normal}
      .footer{flex-direction:column;align-items:stretch}
      .actions{justify-content:flex-end}
    }

    .actions{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap}
    .btn{
      height:40px;padding:0 14px;border-radius:999px;
      border:1px solid var(--line);background:#fff;font-weight:800;font-size:13px;cursor:pointer;
    }
    .btnPrimary{
      border-color:transparent;
      background:linear-gradient(180deg,var(--orange2),var(--orange));
      color:#fff;box-shadow:0 10px 22px rgba(255,122,0,.25);
    }
    .btn:active{transform:translateY(1px)}
    .toast{
      position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
      background:rgba(11,18,32,.92);color:#fff;padding:10px 12px;border-radius:999px;
      font-size:12px;opacity:0;pointer-events:none;transition:opacity .2s ease;
    }
    .toast.show{opacity:1}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <img src="logo.png" alt="Advency" class="logo" />
      <div class="brand">
        <h1>Advency • Calculadora Solar</h1>
        <p>Paneles → Watts DC → EPC (auto) → Precio → Comisión → Fee</p>
      </div>
    </div>

    <div class="card">
      <div class="cardHead">
        <div class="hint">EPC y baterías se calculan automáticamente según la tabla (por cantidad de paneles).</div>
      </div>

      <div class="grid">
        <div class="row2">
          <div class="field">
            <label for="panels">Paneles</label>
            <input id="panels" type="number" min="0" step="1" value="10" />
          </div>
          <div class="field">
            <label for="wattsPerPanel">Watts por panel</label>
            <input id="wattsPerPanel" type="number" min="0" step="1" value="410" />
          </div>
        </div>

        <div class="row2">
          <div class="field">
            <label for="adders">Adders ($) (LUMA / trabajos / otros)</label>
            <input id="adders" type="number" step="1" value="0" />
          </div>

          <div class="row2">
            <div class="field">
              <label for="commissionPct">% Comisión</label>
              <input id="commissionPct" type="number" min="0" step="0.01" value="13" />
            </div>
            <div class="field">
              <label for="crmFeePct">% Fee CRM</label>
              <input id="crmFeePct" type="number" min="0" step="0.01" value="10" />
            </div>
          </div>
        </div>
      </div>

      <div class="kpi">
        <div class="box soft">
          <div class="t">Precio del sistema</div>
          <div class="v" id="systemPrice">$0</div>
          <div class="s" id="batteryHint">Baterías Tesla 3: —</div>
        </div>

        <div class="box">
          <div class="t">Watts DC / kW-DC</div>
          <div class="v" id="wattsKpi">0 W</div>
          <div class="s" id="kwKpi">0.00 kW-DC</div>
        </div>

        <div class="box">
          <div class="t">Comisión bruta</div>
          <div class="v" id="grossCommission">$0</div>
          <div class="s">Precio × % comisión</div>
        </div>

        <div class="box">
          <div class="t">Fee / Neto</div>
          <div class="v" id="feeNet">$0 • $0</div>
          <div class="s">Fee CRM y comisión neta</div>
        </div>
      </div>

      <div class="footer">
        <div class="formula" id="formulaLine">—</div>
        <div class="actions">
          <button class="btn" id="copyBtn">Copiar</button>
          <button class="btn btnPrimary" id="shareBtn">Compartir</button>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Copiado ✅</div>

  <script>
    const EPC_TABLE = [
      {p:10, epc:5.577, bat:1},{p:11, epc:5.311, bat:1},{p:12, epc:5.089, bat:1},
      {p:13, epc:4.901, bat:1},{p:14, epc:4.741, bat:1},{p:15, epc:4.601, bat:1},
      {p:16, epc:4.479, bat:1},{p:17, epc:4.372, bat:1},{p:18, epc:4.276, bat:1},
      {p:19, epc:4.190, bat:1},{p:20, epc:4.113, bat:1},{p:21, epc:4.044, bat:1},
      {p:22, epc:3.980, bat:1},{p:23, epc:3.923, bat:1},{p:24, epc:3.870, bat:1},
      {p:25, epc:3.821, bat:1},{p:26, epc:3.776, bat:1},{p:27, epc:3.734, bat:1},
      {p:28, epc:3.695, bat:1},{p:29, epc:3.659, bat:1},{p:30, epc:3.626, bat:1},
      {p:31, epc:4.538, bat:2},{p:32, epc:4.479, bat:2},{p:33, epc:4.424, bat:2},
      {p:34, epc:4.372, bat:2},{p:35, epc:4.322, bat:2},{p:36, epc:4.276, bat:2},
      {p:37, epc:4.232, bat:2},{p:38, epc:4.190, bat:2},{p:39, epc:4.151, bat:2},
      {p:40, epc:4.113, bat:2},{p:41, epc:4.078, bat:2},{p:42, epc:4.044, bat:2},
      {p:43, epc:4.011, bat:2},{p:44, epc:3.980, bat:2},{p:45, epc:3.951, bat:2},
      {p:46, epc:3.923, bat:2},{p:47, epc:3.895, bat:2},{p:48, epc:3.870, bat:2},
      {p:49, epc:3.845, bat:2},{p:50, epc:3.821, bat:2},
    ];

    const $ = (id)=>document.getElementById(id);

    function money(n){
      if(!isFinite(n)) n = 0;
      return n.toLocaleString('en-US',{style:'currency', currency:'USD', maximumFractionDigits:0});
    }
    function num(n, d=3){
      if(!isFinite(n)) n = 0;
      return n.toLocaleString('en-US',{minimumFractionDigits:d, maximumFractionDigits:d});
    }

    function getTableRow(panels){
      let best = EPC_TABLE[0];
      let bestDiff = Math.abs(panels - best.p);
      for(const r of EPC_TABLE){
        const diff = Math.abs(panels - r.p);
        if(diff < bestDiff){ best = r; bestDiff = diff; }
      }
      return best;
    }

    function compute(){
      const panels = Math.max(0, parseInt($('panels').value || '0', 10));
      const wattsPerPanel = Math.max(0, parseInt($('wattsPerPanel').value || '0', 10));
      const adders = parseFloat($('adders').value || '0') || 0;

      const commissionPct = (parseFloat($('commissionPct').value || '0') || 0) / 100;
      const crmFeePct = (parseFloat($('crmFeePct').value || '0') || 0) / 100;

      const row = getTableRow(panels);
      const epc = row.epc;

      const wattsDC = panels * wattsPerPanel;     // W
      const kwDC = wattsDC / 1000;

      // Fórmula: (paneles * watts) * EPC + adders
      const basePrice = wattsDC * epc;
      const systemPrice = basePrice + adders;

      const grossCommission = systemPrice * commissionPct;
      const crmFee = grossCommission * crmFeePct;
      const netCommission = grossCommission - crmFee;

      $('systemPrice').textContent = money(systemPrice);
      $('wattsKpi').textContent = wattsDC.toLocaleString('en-US') + ' W';
      $('kwKpi').textContent = kwDC.toFixed(2) + ' kW-DC';
      $('grossCommission').textContent = money(grossCommission);
      $('feeNet').textContent = money(crmFee) + ' • ' + money(netCommission);

      $('batteryHint').textContent = `Baterías Tesla 3: ${row.bat}`;
      $('formulaLine').textContent =
        `EPC auto: ${num(epc,3)} — Fórmula: (${panels}×${wattsPerPanel}=${wattsDC})×${num(epc,3)} + ${money(adders)}`;
    }

    function summaryText(){
      const panels = parseInt($('panels').value || '0', 10) || 0;
      const wattsPerPanel = parseInt($('wattsPerPanel').value || '0', 10) || 0;
      const adders = parseFloat($('adders').value || '0') || 0;
      const commissionPct = parseFloat($('commissionPct').value || '0') || 0;
      const crmFeePct = parseFloat($('crmFeePct').value || '0') || 0;

      const row = getTableRow(panels);
      const epc = row.epc;

      const wattsDC = panels * wattsPerPanel;
      const kwDC = wattsDC / 1000;

      const systemPrice = (wattsDC * epc) + adders;
      const grossCommission = systemPrice * (commissionPct/100);
      const crmFee = grossCommission * (crmFeePct/100);
      const netCommission = grossCommission - crmFee;

      return [
        `ADVENCY • RESUMEN`,
        `Paneles: ${panels}`,
        `Watts/panel: ${wattsPerPanel}W`,
        `Watts DC: ${wattsDC.toLocaleString('en-US')}W   |   kW-DC: ${kwDC.toFixed(2)}`,
        `EPC (auto): ${epc.toFixed(3)}`,
        `Baterías Tesla 3: ${row.bat}`,
        `Adders: ${money(adders)}`,
        `Precio sistema: ${money(systemPrice)}`,
        `Comisión (${commissionPct}%): ${money(grossCommission)}`,
        `Fee CRM (${crmFeePct}%): ${money(crmFee)}`,
        `Neto: ${money(netCommission)}`
      ].join('\n');
    }

    async function copySummary(){
      const text = summaryText();
      try{
        await navigator.clipboard.writeText(text);
        showToast('Copiado ✅');
      }catch(e){
        prompt('Copia el resumen:', text);
      }
    }

    async function shareSummary(){
      const text = summaryText();
      try{
        if(navigator.share){
          await navigator.share({ title:'Advency • Resumen', text });
        }else{
          await navigator.clipboard.writeText(text);
          showToast('Copiado para compartir ✅');
        }
      }catch(e){}
    }

    let toastTimer=null;
    function showToast(msg){
      const t = $('toast');
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>t.classList.remove('show'), 1400);
    }

    ['panels','wattsPerPanel','adders','commissionPct','crmFeePct']
      .forEach(id => $(id).addEventListener('input', compute));
    $('copyBtn').addEventListener('click', copySummary);
    $('shareBtn').addEventListener('click', shareSummary);

    compute();
  </script>
</body>
</html>
