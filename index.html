<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Advency • Calculadora Solar</title>
  <style>
    :root{
      --bg:#fff;
      --text:#0b1220;
      --muted:#667085;
      --line:#eaecf0;
      --orange:#ff6a00;
      --soft:#fff3eb;
      --shadow:0 18px 55px rgba(2,6,23,.08);
      --r:18px;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 450px at 85% -10%, rgba(255,106,0,.10), transparent 60%),
        radial-gradient(900px 450px at 10% -10%, rgba(255,106,0,.06), transparent 60%),
        var(--bg);
      padding: 18px;
    }
    .wrap{max-width:900px;margin:0 auto}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border:1px solid var(--line);border-radius:20px;
      background:rgba(255,255,255,.86);backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(2,6,23,.05);
    }
    .brand{display:flex;align-items:center;gap:12px;min-width:0}
    .brand img{height:30px;width:auto;display:block}
    .brand .t{min-width:0}
    .brand .t b{display:block;font-size:14px;letter-spacing:.2px}
    .brand .t span{display:block;font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .chip{
      font-size:12px;font-weight:800;color:#9a3412;
      background:var(--soft);border:1px solid rgba(255,106,0,.25);
      padding:8px 10px;border-radius:999px;white-space:nowrap;
    }

    .card{
      margin-top:14px;
      border:1px solid var(--line);border-radius:var(--r);
      background:rgba(255,255,255,.92);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card .in{padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px}
    input,select{
      width:100%;
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      font-size:14px;
      outline:none;
      background:#fff;
      color:var(--text);
    }
    input:focus,select:focus{
      border-color: rgba(255,106,0,.55);
      box-shadow: 0 0 0 4px rgba(255,106,0,.12);
    }

    .results{
      border-top:1px solid var(--line);
      padding:16px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      background: linear-gradient(180deg, rgba(255,106,0,.05), transparent 70%);
    }
    @media (max-width:720px){.results{grid-template-columns:1fr}}
    .kpi{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }
    .kpi .k{font-size:11px;color:var(--muted);letter-spacing:.12em;text-transform:uppercase}
    .kpi .v{margin-top:8px;font-size:22px;font-weight:900}
    .kpi.orange{border-color: rgba(255,106,0,.22);background: linear-gradient(180deg, rgba(255,106,0,.08), #fff)}
    .row{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      padding: 12px 16px;border-top:1px solid var(--line);background:#fff;
    }
    .mini{font-size:12px;color:var(--muted);line-height:1.35}
    .btn{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      background:#fff;
      font-weight:900;
      cursor:pointer;
    }
    .btn.primary{
      color:#fff;
      border-color: rgba(255,106,0,.65);
      background: linear-gradient(180deg, var(--orange), #ff7b2c);
      box-shadow: 0 12px 22px rgba(255,106,0,.22);
    }
    pre{
      margin:0;
      padding:12px 16px;
      border-top:1px solid var(--line);
      background:#0b1220;
      color:#e5e7eb;
      font-size:12px;
      overflow:auto;
      white-space:pre-wrap;
      word-break:break-word;
    }
  </style>
</head>
<body>
  <div class="wrap">

    <div class="top">
      <div class="brand">
        <img src="logo.png" alt="Advency" onerror="this.style.display='none'">
        <div class="t">
          <b>Advency • Calculadora Solar</b>
          <span>Paneles → Watts DC → EPC → Precio → Comisión → Fee</span>
        </div>
      </div>
      <div class="chip">PR Solar</div>
    </div>

    <div class="card">
      <div class="in">
        <div class="grid">
          <div>
            <label>Paneles</label>
            <input id="panels" type="number" min="1" step="1" value="10">
          </div>

          <div>
            <label>Watts por panel</label>
            <input id="wpp" type="number" min="100" step="1" value="410">
          </div>

          <div>
            <label>EPC</label>
            <select id="epcMode">
              <option value="auto">Auto (tabla 10–50)</option>
              <option value="manual" selected>Manual</option>
            </select>
          </div>

          <div>
            <label>EPC manual</label>
            <input id="epcManual" type="number" min="0" step="0.001" value="5.100">
          </div>

          <div>
            <label>Adders ($) (LUMA / trabajos / otros)</label>
            <input id="adders" type="number" min="0" step="1" value="0">
          </div>

          <div>
            <label>% Comisión / % Fee CRM</label>
            <div class="grid" style="grid-template-columns:1fr 1fr;gap:10px">
              <input id="commPct" type="number" min="0" step="0.01" value="13" placeholder="% comisión">
              <input id="feePct" type="number" min="0" step="0.01" value="10" placeholder="% fee">
            </div>
          </div>
        </div>
      </div>

      <div class="results">
        <div class="kpi orange">
          <div class="k">Precio del sistema</div>
          <div class="v" id="price">$0</div>
        </div>
        <div class="kpi">
          <div class="k">Watts DC / kW-DC</div>
          <div class="v" id="size">—</div>
        </div>
        <div class="kpi">
          <div class="k">Comisión bruta</div>
          <div class="v" id="gross">$0</div>
        </div>
        <div class="kpi">
          <div class="k">Fee / Neto</div>
          <div class="v" id="net">—</div>
        </div>
      </div>

      <div class="row">
        <div class="mini" id="epcInfo">EPC aplicado: —</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <button class="btn" id="copyBtn">Copiar</button>
          <button class="btn primary" id="shareBtn">Compartir</button>
        </div>
      </div>

      <pre id="summary"></pre>
    </div>

  </div>

  <script>
    // ====== EDITA AQUÍ TU TABLA EPC BASE (si quieres auto exacto) ======
    // Si tu tabla cambia, reemplaza estos valores.
    const EPC_BASE = {
      10: 5.577, 11: 5.311, 12: 5.089, 13: 4.901, 14: 4.741,
      15: 4.601, 16: 4.479, 17: 4.372, 18: 4.276, 19: 4.190,
      20: 4.113, 21: 4.044, 22: 3.980, 23: 3.923, 24: 3.870,
      25: 3.821, 26: 3.776, 27: 3.734, 28: 3.695, 29: 3.659,
      30: 3.626,
      31: 4.538, 32: 4.479, 33: 4.424, 34: 4.372, 35: 4.322,
      36: 4.276, 37: 4.232, 38: 4.190, 39: 4.151, 40: 4.113,
      41: 4.078, 42: 4.044, 43: 4.011, 44: 3.980, 45: 3.951,
      46: 3.923, 47: 3.895, 48: 3.870, 49: 3.845, 50: 3.821
    };

    const $ = (id) => document.getElementById(id);

    function money(n){
      const v = Number(n||0);
      return v.toLocaleString('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0});
    }

    function calc(){
      const panels = Math.max(1, Math.round(Number($('panels').value||0)));
      const wpp = Math.max(0, Number($('wpp').value||0));
      const wattsDC = panels * wpp;
      const kwdc = wattsDC / 1000;

      const epcMode = $('epcMode').value;
      const epcAuto = EPC_BASE[panels];
      const epcManual = Number($('epcManual').value||0);
      const epc = (epcMode === 'auto' && epcAuto) ? epcAuto : epcManual;

      const adders = Math.max(0, Number($('adders').value||0));
      const commPct = Math.max(0, Number($('commPct').value||0))/100;
      const feePct = Math.max(0, Number($('feePct').value||0))/100;

      const base = wattsDC * epc;
      const price = base + adders;

      const gross = price * commPct;
      const fee = gross * feePct;
      const net = gross - fee;

      $('price').textContent = money(price);
      $('size').textContent = `${wattsDC.toLocaleString()} W • ${kwdc.toFixed(2)} kW-DC`;
      $('gross').textContent = money(gross);
      $('net').textContent = `${money(fee)} • ${money(net)}`;

      $('epcInfo').textContent =
        `EPC aplicado: ${epc.toFixed(3)} ${epcMode==='auto' && epcAuto ? '(auto)' : '(manual)'} — Fórmula: (${panels}×${wpp}=${wattsDC})×${epc.toFixed(3)} + ${money(adders)}`;

      const text =
`ADVENCY • RESUMEN
Paneles: ${panels}
Watts/panel: ${wpp}W
Watts DC: ${wattsDC.toLocaleString()}W  |  kW-DC: ${kwdc.toFixed(2)}
EPC: ${epc.toFixed(3)} ${epcMode==='auto' && epcAuto ? '(auto)' : '(manual)'}
Adders: ${money(adders)}

Precio sistema: ${money(price)}
% Comisión: ${(commPct*100).toFixed(2)}%  → Comisión: ${money(gross)}
Fee CRM: ${(feePct*100).toFixed(2)}%  → Fee: ${money(fee)}
Neto: ${money(net)}`;

      $('summary').textContent = text;
      return text;
    }

    async function copySummary(){
      const text = calc();
      try{
        await navigator.clipboard.writeText(text);
        $('copyBtn').textContent = '✅ Copiado';
        setTimeout(()=> $('copyBtn').textContent='Copiar', 1200);
      }catch(e){
        alert('No pude copiar automáticamente. Copia manualmente el resumen.');
      }
    }

    async function shareSummary(){
      const text = calc();
      // iPhone/iPad: abre el share sheet (WhatsApp incluido)
      if (navigator.share){
        try{ await navigator.share({ title:'Advency • Resumen Solar', text }); }
        catch(e){ /* cancelado */ }
      } else {
        // fallback: abre WhatsApp con el texto
        window.open('https://wa.me/?text=' + encodeURIComponent(text), '_blank');
      }
    }

    // events
    ['panels','wpp','epcMode','epcManual','adders','commPct','feePct']
      .forEach(id=>{
        $(id).addEventListener('input', calc);
        $(id).addEventListener('change', calc);
      });
    $('copyBtn').addEventListener('click', copySummary);
    $('shareBtn').addEventListener('click', shareSummary);

    calc();
  </script>
</body>
</html>
